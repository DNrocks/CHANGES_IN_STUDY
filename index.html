<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Study Tracker</title>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/firebase/8.10.1/firebase-app.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/firebase/8.10.1/firebase-firestore.min.js"></script>
  <style>
    :root {
      --bg: #f4f4f4;
      --panel: #ffffff;
      --text: #222;
      --muted: #6b7280;
      --sidebar: #e5e7eb;
      --btn: #3498db;
      --btn-text: #fff;
      --danger: #e74c3c;
      --ok: #27ae60;
      --warn: #e67e22;
      --skip: #7f8c8d;
      --shadow: 0 2px 10px #0001;
    }

    body.dark {
      --bg: #0d0f12;
      --panel: #111418;
      --text: #e5e7eb;
      --muted: #9aa0a6;
      --sidebar: #0f1318;
      --btn: #3b82f6;
      --btn-text: #e5e7eb;
      --shadow: 0 2px 10px #0007;
    }

    * { box-sizing: border-box; }

    body {
      margin: 0;
      font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
      background: var(--bg);
      color: var(--text);
      transition: background 0.3s, color 0.3s;
    }

    #app {
      display: flex;
      min-height: 100vh;
    }

    #main {
      flex: 1;
      padding: 20px;
      display: flex;
      flex-direction: column;
      gap: 14px;
    }

    h1 { margin: 0 0 10px; }

    .muted { color: var(--muted); }

    #profileControls,
    #sessionControls,
    #questionControls {
      background: var(--panel);
      border-radius: 8px;
      box-shadow: var(--shadow);
      padding: 12px;
      display: flex;
      gap: 10px;
      flex-wrap: wrap;
      align-items: center;
    }

    #timerDisplay {
      background: var(--panel);
      box-shadow: var(--shadow);
      border-radius: 8px;
      padding: 12px;
      font-size: 1.6rem;
      font-weight: 700;
      width: fit-content;
    }

    #questionGrid {
      background: var(--panel);
      box-shadow: var(--shadow);
      border-radius: 8px;
      padding: 12px;
      display: flex;
      flex-wrap: wrap;
      gap: 6px;
      min-height: 48px;
    }

    .square {
      width: 28px;
      height: 28px;
      border-radius: 4px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 0.8em;
      font-weight: 700;
      color: #fff;
    }
    .correct { background: var(--ok); }
    .wrong   { background: var(--danger); }
    .skipped { background: var(--skip); }

    #sessions {
      list-style: none;
      padding-left: 0;
      display: flex;
      flex-direction: column;
      gap: 10px;
    }
    #sessions li {
      background: var(--panel);
      box-shadow: var(--shadow);
      border-radius: 8px;
      padding: 12px;
    }
    .session-head {
      display: flex;
      justify-content: space-between;
      gap: 12px;
      align-items: center;
      font-weight: 600;
    }
    .session-meta {
      font-size: 0.92rem;
      color: var(--muted);
    }
    .session-breakdown {
      margin-top: 8px;
      font-size: 0.95rem;
    }
    .small-legend {
      margin-top: 8px;
      color: var(--muted);
      font-size: 0.85rem;
    }

    #sidebar {
      width: 190px;
      background: var(--sidebar);
      padding: 16px;
      display: flex;
      flex-direction: column;
      gap: 10px;
      border-left: 1px solid rgba(0,0,0,0.06);
    }

    button {
      padding: 10px 12px;
      border: none;
      border-radius: 8px;
      background: var(--btn);
      color: var(--btn-text);
      cursor: pointer;
      box-shadow: var(--shadow);
      transition: filter 0.2s;
    }
    button:hover { filter: brightness(1.05); }
    button:disabled { 
      opacity: 0.5; 
      cursor: not-allowed; 
      filter: none;
    }

    button.danger { background: var(--danger); }
    button.neutral { background: #64748b; }

    input, select {
      padding: 10px;
      border-radius: 8px;
      border: 1px solid #0002;
      background: var(--panel);
      color: inherit;
    }

    .panel {
      background: var(--panel);
      border-radius: 8px;
      box-shadow: var(--shadow);
      padding: 12px;
    }
    .hidden { display: none; }

    .modal {
      display: none;
      position: fixed;
      z-index: 25;
      left: 0; top: 0; right: 0; bottom: 0;
      background: rgba(0,0,0,0.6);
    }
    .modal-content {
      background: var(--panel);
      color: var(--text);
      margin: 4% auto;
      padding: 18px;
      width: min(920px, 92vw);
      border-radius: 10px;
      box-shadow: var(--shadow);
      max-height: 80vh;       /* ADDED */
      overflow-y: auto;       /* ADDED */
    }

    .close {
      float: right;
      font-size: 1.6rem;
      cursor: pointer;
      line-height: 1;
    }

    .status-indicator {
      padding: 4px 8px;
      border-radius: 4px;
      font-size: 0.8em;
      margin-left: 10px;
    }
    .status-connected { background: var(--ok); color: white; }
    .status-error { background: var(--danger); color: white; }

    @media (max-width: 900px) {
      #app { flex-direction: column; }
      #sidebar { width: 100%; order: -1; flex-direction: row; flex-wrap: wrap; }
    }
  </style>
</head>
<body>
  <div id="app">
    <div id="main">
      <h1>Study Tracker <span id="connectionStatus" class="status-indicator status-error">Connecting...</span></h1>

      <div id="profileControls">
        <select id="profileSelect" aria-label="Select profile"></select>
        <input id="newProfileInput" placeholder="New Profile Name" />
        <button id="createProfileBtn">Create Profile</button>
      </div>
      <div id="currentProfile" class="muted"></div>
      <div id="profileXP" style="color:red; font-weight:bold;"></div>
      <div id="todoPanel" class="panel hidden">
        <h3>To-Do List</h3>
        <div style="display:flex; gap:8px; margin-bottom:10px;">
          <input id="todoInput" placeholder="New task..." style="flex:1" />
          <button id="addTodoBtn">Add</button>
        </div>
        <ul id="todoList"></ul>
      </div>



      <div id="sessionControls">
        <input id="exName" placeholder="Session Name (e.g., Arrays, Sorting...)" />
        <button id="startSessionBtn" disabled>Start Session</button>
        <button id="pauseResumeBtn" disabled>Pause</button>
        <button id="endSessionBtn" disabled>End Session</button>
      </div>

      <div id="timerDisplay">00:00:00</div>

      <div id="questionControls">
        <button id="correctBtn" disabled>‚úî Correct</button>
        <button id="wrongBtn" disabled>‚ùå Wrong</button>
        <button id="skippedBtn" disabled>‚è≠ Skipped</button>
      </div>

      <div id="questionGrid" aria-label="Question outcomes grid"></div>

      <h2>Previous Sessions</h2>
      <ul id="sessions"></ul>

      <div id="statsPanel" class="panel hidden">
        <h3>Profile Stats</h3>
        <div id="statsContent"></div>
      </div>
    </div>

    <aside id="sidebar" aria-label="Sidebar actions">
      <button id="darkModeBtn">üåô Dark Mode</button>
      <button id="exportPdfBtn">üìÑ Export PDF</button>
      <button id="exportJsonBtn">üíæ Export JSON</button>
      <input type="file" id="importJsonInput" accept="application/json" style="display:none" />
      <button id="importJsonBtn">üìÇ Add Previous Data</button>
      <button id="showStatsBtn">üìä Profile Stats</button>
      <button id="showGraphsBtn">üìà Graphs</button>
      <button id="showTodoBtn">üìù To-Do</button>

    </aside>
  </div>

  <div id="graphModal" class="modal" aria-hidden="true">
    <div class="modal-content">
      <span class="close" id="closeGraphModal" role="button" aria-label="Close graphs">&times;</span>
      <h3>Weekly (per day, last 7 days)</h3>
      <canvas id="weeklyChart" height="160"></canvas>
      <h3 style="margin-top:20px;">Monthly (per week, last 8 weeks)</h3>
      <canvas id="monthlyChart" height="160"></canvas>
      <h3 style="margin-top:20px;">Per-Session Breakdown (Correct vs Wrong vs Skipped)</h3>
      <canvas id="sessionBreakdownChart" height="160"></canvas>

    </div>
  </div>

  <script>
    /* ========= Firebase Configuration & Initialization ========= */
    const firebaseConfig = {
      apiKey: "AIzaSyAnvFB9d9zVMcwFTfGLKeVZ2sRdIvW1mDM",
  authDomain: "study2-72458.firebaseapp.com",
  projectId: "study2-72458",
  storageBucket: "study2-72458.firebasestorage.app",
  messagingSenderId: "24601894704",
  appId: "1:24601894704:web:2787977ef99689dcaff2f5",
  measurementId: "G-RVVQKPXY6S"
    };

    // Initialize Firebase
    let app, db;
    let connectionStatus = document.getElementById("connectionStatus");

    function initializeFirebase() {
      try {
        // Check if Firebase is loaded
        if (typeof firebase === 'undefined') {
          console.error("Firebase SDK not loaded");
          connectionStatus.textContent = "SDK Not Loaded";
          connectionStatus.className = "status-indicator status-error";
          return;
        }

        app = firebase.initializeApp(firebaseConfig);
        db = firebase.firestore();
        
        console.log("Firebase initialized, testing connection...");
        
        // Test connection with a simple read operation
        db.collection("profiles").limit(1).get()
          .then(() => {
            connectionStatus.textContent = "Connected";
            connectionStatus.className = "status-indicator status-connected";
            console.log("Firebase connected successfully");
            
            // Now that we're connected, load the data
            loadDataAndRender();
          })
          .catch(err => {
            console.error("Firebase connection test failed:", err);
            connectionStatus.textContent = "Connection Error";
            connectionStatus.className = "status-indicator status-error";
            
            // Show more specific error info
            if (err.code === 'permission-denied') {
              alert("Database access denied. Please check your Firestore security rules.");
            } else if (err.code === 'unavailable') {
              alert("Database unavailable. Please check your internet connection.");
            }
          });
      } catch (err) {
        console.error("Firebase initialization failed:", err);
        connectionStatus.textContent = "Init Error";
        connectionStatus.className = "status-indicator status-error";
        
        if (err.message.includes('already exists')) {
          console.log("Firebase already initialized, getting existing instance");
          app = firebase.app();
          db = firebase.firestore();
          loadDataAndRender();
        }
      }
    }

    /* ========= Data ========= */
    let profiles = [];
    let sessions = {}; // Map profile -> sessions[] for local caching
    let currentProfile = null;
    let currentSession = null;

    let timerInterval = null;
    let elapsedMs = 0;
    let paused = false;

    /* ========= DOM Elements ========= */
    const profileSelect = document.getElementById("profileSelect");
    const newProfileInput = document.getElementById("newProfileInput");
    const createProfileBtn = document.getElementById("createProfileBtn");
    const currentProfileView = document.getElementById("currentProfile");

    const exNameInput = document.getElementById("exName");
    const startBtn = document.getElementById("startSessionBtn");
    const pauseBtn = document.getElementById("pauseResumeBtn");
    const endBtn = document.getElementById("endSessionBtn");

    const timerDisplay = document.getElementById("timerDisplay");
    const correctBtn = document.getElementById("correctBtn");
    const wrongBtn = document.getElementById("wrongBtn");
    const skippedBtn = document.getElementById("skippedBtn");
    const questionGrid = document.getElementById("questionGrid");
    const sessionsList = document.getElementById("sessions");

    const darkModeBtn = document.getElementById("darkModeBtn");
    const exportPdfBtn = document.getElementById("exportPdfBtn");
    const exportJsonBtn = document.getElementById("exportJsonBtn");
    const importJsonBtn = document.getElementById("importJsonBtn");
    const importJsonInput = document.getElementById("importJsonInput");
    const showStatsBtn = document.getElementById("showStatsBtn");
    const statsPanel = document.getElementById("statsPanel");
    const statsContent = document.getElementById("statsContent");

    const showGraphsBtn = document.getElementById("showGraphsBtn");
    const graphModal = document.getElementById("graphModal");
    const closeGraphModal = document.getElementById("closeGraphModal");
    const weeklyCanvas = document.getElementById("weeklyChart");
    const monthlyCanvas = document.getElementById("monthlyChart");

    let weeklyChart = null;
    let monthlyChart = null;
    let perSessionChart = null;

    /* ========= Utilities ========= */
    function formatTime(ms) {
      const s = Math.floor(ms / 1000);
      const h = String(Math.floor(s / 3600)).padStart(2, "0");
      const m = String(Math.floor((s % 3600) / 60)).padStart(2, "0");
      const sec = String(s % 60).padStart(2, "0");
      return `${h}:${m}:${sec}`;
    }

    function percent(n, d) {
      if (!d) return "0%";
      return Math.round((n / d) * 100) + "%";
    }

    function setStudyControlsEnabled(running) {
      // Inputs
      exNameInput.disabled = running;
      startBtn.disabled = running || !exNameInput.value.trim() || !currentProfile;

      // Timer buttons
      pauseBtn.disabled = !running;
      endBtn.disabled = !running;

      // Question buttons
      correctBtn.disabled = !running;
      wrongBtn.disabled = !running;
      skippedBtn.disabled = !running;
    }

    /* ========= Profiles & Data Loading ========= */
    async function loadDataAndRender() {
      if (!db) {
        console.error("Database not initialized");
        return;
      }

      try {
        console.log("Loading profiles from Firestore...");
        const profileSnapshot = await db.collection("profiles").orderBy("name").get();
        profiles = profileSnapshot.docs.map(doc => doc.id);
        console.log("Loaded profiles:", profiles);
        
        renderProfiles();
        
        if (profiles.length === 0) {
          console.log("No profiles found, creating default profile...");
          await createDefaultProfile();
        }
      } catch (err) {
        console.error("Error loading profiles:", err);
        
        // More specific error handling
        if (err.code === 'permission-denied') {
          alert("Access denied to Firestore. Please check your security rules:\n\nrules_version = '2';\nservice cloud.firestore {\n  match /databases/{database}/documents {\n    match /{document=**} {\n      allow read, write: if true;\n    }\n  }\n}");
        } else {
          alert("Could not load profiles from Firestore. Check console for details.");
        }
      }
    }

    async function createDefaultProfile() {
      const defaultName = "Default";
      try {
        await db.collection("profiles").doc(defaultName).set({ name: defaultName });
        profiles.push(defaultName);
        renderProfiles();
        selectProfile(defaultName);
      } catch (err) {
        console.error("Error creating default profile:", err);
      }
    }

    function renderProfiles() {
      profileSelect.innerHTML = "";
      profiles.forEach(p => {
        const opt = document.createElement("option");
        opt.value = p;
        opt.textContent = p;
        profileSelect.appendChild(opt);
      });

      if (profiles.length && !currentProfile) {
        profileSelect.value = profiles[0];
        selectProfile(profiles[0]);
      } else if (currentProfile) {
        profileSelect.value = currentProfile;
      }
    }

    async function selectProfile(name) {
      if (!db) return;
      
      currentProfile = name;
      currentProfileView.textContent = `Profile: ${name}`;
      loadTodos(name);
      // Use a real-time listener for sessions
      try {
        db.collection("sessions")
          .where("profileName", "==", name)
          .orderBy("start", "desc")
          .onSnapshot(snapshot => {
            sessions[name] = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
            renderSessions();
            renderStatsPanel();
            if (graphModal.style.display === "block") renderGraphs();
          }, err => {
            console.error("Error listening to sessions:", err);
          });
      } catch (err) {
        console.error("Error setting up session listener:", err);
      }

      // Update UI state
      setStudyControlsEnabled(!!currentSession);
    }

    /* ========= Event Handlers ========= */
    createProfileBtn.onclick = async () => {
      const name = newProfileInput.value.trim();
      if (!name) return alert("Enter a profile name");
      if (profiles.includes(name)) {
        alert("Profile already exists");
        return;
      }
      
      if (!db) return alert("Database not connected");
      
      try {
        await db.collection("profiles").doc(name).set({ name });
        profiles.push(name);
        newProfileInput.value = "";
        renderProfiles();
        selectProfile(name);
      } catch (err) {
        console.error("Error creating profile:", err);
        alert("Could not create profile. Check console for details.");
      }
    };

    profileSelect.onchange = () => {
      if (profileSelect.value) {
        selectProfile(profileSelect.value);
      }
    };

    /* ========= Session Lifecycle ========= */
    exNameInput.addEventListener("input", () => {
      setStudyControlsEnabled(!!currentSession);
    });

    function startTimer() {
      clearInterval(timerInterval);
      timerInterval = setInterval(() => {
        if (!paused) {
          elapsedMs += 1000;
          timerDisplay.textContent = formatTime(elapsedMs);
        }
      }, 1000);
    }

    startBtn.onclick = () => {
      if (!currentProfile) return alert("Select a profile first");
      if (currentSession) return alert("A session is already running");
      const name = exNameInput.value.trim();
      if (!name) return alert("Enter a session name");

      currentSession = {
        name,
        start: Date.now(),
        durationMs: 0,
        boxes: [],
        correct: 0,
        wrong: 0,
        skipped: 0
      };
      elapsedMs = 0;
      paused = false;
      questionGrid.innerHTML = "";
      timerDisplay.textContent = "00:00:00";
      startTimer();
      setStudyControlsEnabled(true);
    };

    pauseBtn.onclick = () => {
      if (!currentSession) return;
      paused = !paused;
      pauseBtn.textContent = paused ? "Resume" : "Pause";
    };

    endBtn.onclick = async () => {
      if (!currentSession) return;
      if (!db) return alert("Database not connected");
      
      clearInterval(timerInterval);
      currentSession.durationMs = elapsedMs;
      currentSession.end = Date.now();
      currentSession.total = currentSession.correct + currentSession.wrong + currentSession.skipped;
      currentSession.profileName = currentProfile;

      try {
        await db.collection("sessions").add(currentSession);
        console.log("Session saved successfully");
      } catch (err) {
        console.error("Error saving session:", err);
        alert("Could not save session to Firestore. Check console for details.");
      }

      // Reset UI
      currentSession = null;
      elapsedMs = 0;
      timerDisplay.textContent = "00:00:00";
      pauseBtn.textContent = "Pause";
      setStudyControlsEnabled(false);
    };

    function addBox(type) {
      if (!currentSession) return alert("Start a session first");
      const n = currentSession.boxes.length + 1;
      const div = document.createElement("div");
      div.className = `square ${type}`;
      div.textContent = n;
      questionGrid.appendChild(div);

      currentSession.boxes.push(type);
      currentSession[type] += 1;
    }

    correctBtn.onclick = () => addBox("correct");
    wrongBtn.onclick   = () => addBox("wrong");
    skippedBtn.onclick = () => addBox("skipped");

    /* ========= History ========= */
    async function deleteSession(sessionId) {
      if (!confirm("Are you sure you want to delete this session?")) return;
      if (!db) return alert("Database not connected");
      
      try {
        await db.collection("sessions").doc(sessionId).delete();
        console.log("Session deleted successfully");
      } catch (err) {
        console.error("Error deleting session:", err);
        alert("Could not delete session from Firestore. Check console for details.");
      }
    }
    window.deleteSession = deleteSession;

    function renderSessions() {
      sessionsList.innerHTML = "";
      if (!currentProfile || !sessions[currentProfile] || !sessions[currentProfile].length) {
        const empty = document.createElement("li");
        empty.className = "muted";
        empty.textContent = "No sessions yet.";
        sessionsList.appendChild(empty);
        return;
      }

      sessions[currentProfile].forEach((s) => {
        const li = document.createElement("li");
        const total = s.correct + s.wrong + s.skipped;
        const head = document.createElement("div");
        head.className = "session-head";
        head.innerHTML = `
          <span>${s.name}</span>
          <button class="danger" onclick="deleteSession('${s.id}')">Delete</button>
        `;

        const meta = document.createElement("div");
        meta.className = "session-meta";
        const startStr = new Date(s.start).toLocaleString();
        meta.textContent = `${startStr} ‚Ä¢ Duration: ${formatTime(s.durationMs)} ‚Ä¢ Questions: ${total}`;

        const bd = document.createElement("div");
        bd.className = "session-breakdown";
        bd.innerHTML = `
          ‚úî ${s.correct} (${percent(s.correct, total)}) &nbsp;|&nbsp;
          ‚ùå ${s.wrong} (${percent(s.wrong, total)}) &nbsp;|&nbsp;
          ‚è≠ ${s.skipped} (${percent(s.skipped, total)})
          <div class="small-legend">Legend: ‚úî Correct ‚Ä¢ ‚ùå Wrong ‚Ä¢ ‚è≠ Skipped</div>
        `;

        li.appendChild(head);
        li.appendChild(meta);
        li.appendChild(bd);
        sessionsList.appendChild(li);
      });
    }

    /* ========= Stats ========= */
    function renderStatsPanel() {
  if (!currentProfile || !sessions[currentProfile]) {
    statsContent.innerHTML = "";
    return;
  }
  const list = sessions[currentProfile] || [];
  const totalSessions = list.length;
  let totalQs = 0;
  let totalDur = 0;
  let sumCorrect = 0, sumWrong = 0, sumSkipped = 0;
  let xpTotal = 0; // moved here

  list.forEach(s => {
    const t = s.correct + s.wrong + s.skipped;
    totalQs += t;
    totalDur += (s.durationMs || 0);
    sumCorrect += s.correct;
    sumWrong += s.wrong;
    sumSkipped += s.skipped;

    xpTotal += (s.correct * 4) + (s.wrong * -1); // merged into same loop
  });

  // update XP display
  document.getElementById("profileXP").textContent = `XP: ${xpTotal}`;

  const avgDur = totalSessions ? formatTime(Math.round(totalDur / totalSessions)) : "00:00:00";

  statsContent.innerHTML = `
    <div><strong>Profile:</strong> ${currentProfile}</div>
    <div><strong>Sessions:</strong> ${totalSessions}</div>
    <div><strong>Total Questions:</strong> ${totalQs}</div>
    <div><strong>Average Duration:</strong> ${avgDur}</div>
    <div style="margin-top:6px;"><strong>Overall Breakdown:</strong>
      ‚úî ${sumCorrect} (${percent(sumCorrect, totalQs)}) &nbsp;|&nbsp;
      ‚ùå ${sumWrong} (${percent(sumWrong, totalQs)}) &nbsp;|&nbsp;
      ‚è≠ ${sumSkipped} (${percent(sumSkipped, totalQs)})
    </div>
  `;
}

const showTodoBtn = document.getElementById("showTodoBtn");
const todoPanel = document.getElementById("todoPanel");
const todoInput = document.getElementById("todoInput");
const addTodoBtn = document.getElementById("addTodoBtn");
const todoList = document.getElementById("todoList");

let todosUnsub = null; // Firestore listener

function loadTodos(profile) {
  if (!db) return;
  if (todosUnsub) todosUnsub(); // stop old listener

  todosUnsub = db.collection("profiles").doc(profile).collection("todos")
    .orderBy("created", "desc")
    .onSnapshot(snapshot => {
      const items = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
      renderTodos(items);
    });
}

function renderTodos(items) {
  todoList.innerHTML = "";
  if (items.length === 0) {
    todoList.innerHTML = `<li class="muted">No tasks yet.</li>`;
    return;
  }

  items.forEach(task => {
    const li = document.createElement("li");
    li.style.display = "flex";
    li.style.justifyContent = "space-between";
    li.style.alignItems = "center";
    li.style.padding = "6px 0";

    const span = document.createElement("span");
    span.textContent = task.text;
    if (task.done) span.style.textDecoration = "line-through";
    span.style.cursor = "pointer";
    span.onclick = () => toggleTodo(task.id, !task.done);

    const del = document.createElement("button");
    del.textContent = "‚úñ";
    del.className = "danger";
    del.style.padding = "4px 8px";
    del.onclick = () => deleteTodo(task.id);

    li.appendChild(span);
    li.appendChild(del);
    todoList.appendChild(li);
  });
}

async function addTodo() {
  const text = todoInput.value.trim();
  if (!text || !currentProfile) return;
  await db.collection("profiles").doc(currentProfile).collection("todos").add({
    text, done: false, created: Date.now()
  });
  todoInput.value = "";
}

function toggleTodo(id, done) {
  if (!currentProfile) return;
  db.collection("profiles").doc(currentProfile).collection("todos").doc(id).update({ done });
}

function deleteTodo(id) {
  if (!currentProfile) return;
  db.collection("profiles").doc(currentProfile).collection("todos").doc(id).delete();
}

showTodoBtn.onclick = () => {
  todoPanel.classList.toggle("hidden");
};

addTodoBtn.onclick = addTodo;

    /* ========= Graphs (Chart.js) ========= */
    function groupDailyLast7Days(list) {
      const today = new Date();
      today.setHours(0,0,0,0);
      const dayMs = 86400000;

      const labels = [];
      const map = {};
      for (let i = 6; i >= 0; i--) {
        const d = new Date(today.getTime() - i * dayMs);
        const key = d.toDateString();
        labels.push(d.toLocaleDateString());
        map[key] = 0;
      }

      list.forEach(s => {
        const d = new Date(s.start);
        d.setHours(0,0,0,0);
        const key = d.toDateString();
        const total = (s.correct + s.wrong + s.skipped);
        if (key in map) map[key] += total;
      });

      const values = Object.keys(map).sort((a,b)=>new Date(a)-new Date(b)).map(k => map[k]);
      return { labels, values };
    }

    function groupWeeklyLast8Weeks(list) {
      function isoWeek(d) {
        const date = new Date(d.getTime());
        date.setHours(0,0,0,0);
        date.setDate(date.getDate() + 3 - ((date.getDay() + 6) % 7));
        const week1 = new Date(date.getFullYear(), 0, 4);
        return 1 + Math.round(((date - week1) / 86400000 - 3 + ((week1.getDay() + 6) % 7)) / 7);
      }
      function isoYear(d) {
        const date = new Date(d.getTime());
        date.setDate(date.getDate() + 3 - ((date.getDay() + 6) % 7));
        return date.getFullYear();
      }

      const now = new Date();
      const buckets = [];
      for (let i = 7; i >= 0; i--) {
        const ref = new Date(now.getTime() - i * 7 * 86400000);
        buckets.push({ y: isoYear(ref), w: isoWeek(ref), label: `W${isoWeek(ref)} ${isoYear(ref)}`, total: 0 });
      }

      list.forEach(s => {
        const d = new Date(s.start);
        const y = isoYear(d);
        const w = isoWeek(d);
        const idx = buckets.findIndex(b => b.y === y && b.w === w);
        if (idx >= 0) {
          buckets[idx].total += (s.correct + s.wrong + s.skipped);
        }
      });

      return {
        labels: buckets.map(b => b.label),
        values: buckets.map(b => b.total)
      };
    }

    function renderGraphs() {
      if (!currentProfile || !sessions[currentProfile]) return;
      const list = sessions[currentProfile] || [];

      const daily = groupDailyLast7Days(list);
      const weekly = groupWeeklyLast8Weeks(list);

      if (weeklyChart) weeklyChart.destroy();
      if (monthlyChart) monthlyChart.destroy();

      weeklyChart = new Chart(weeklyCanvas.getContext("2d"), {
        type: "bar",
        data: {
          labels: daily.labels,
          datasets: [{
            label: "Questions per day (last 7 days)",
            data: daily.values,
            backgroundColor: "#3498db",
            borderColor: "#2980b9",
            borderWidth: 1
          }]
        },
        options: {
          responsive: true,
          plugins: { legend: { display: false } },
          scales: { y: { beginAtZero: true, ticks: { precision:0 } } }
        }
      });

      monthlyChart = new Chart(monthlyCanvas.getContext("2d"), {
        type: "line",
        data: {
          labels: weekly.labels,
          datasets: [{
            label: "Questions per week (last 8 weeks)",
            data: weekly.values,
            borderColor: "#e74c3c",
            backgroundColor: "rgba(231, 76, 60, 0.1)",
            tension: 0.4
          }]
        },
        options: {
          responsive: true,
          plugins: { legend: { display: false } },
          scales: { y: { beginAtZero: true, ticks: { precision:0 } } }
        }
      });
      // --- New per-session breakdown chart ---
      const sessionCtx = document.getElementById("sessionBreakdownChart").getContext("2d");
      if (perSessionChart) perSessionChart.destroy();
      perSessionChart = new Chart(sessionCtx, {
        type: "line",
        data: {
          labels: list.map((s, i) => `S${i + 1}`),
          datasets: [
            {
              label: "Correct",
              data: list.map(s => s.correct),
              borderColor: "#27ae60",
              backgroundColor: "rgba(39, 174, 96, 0.1)",
              tension: 0.3
            },
            {
              label: "Wrong",
              data: list.map(s => s.wrong),
              borderColor: "#e74c3c",
              backgroundColor: "rgba(231, 76, 60, 0.1)",
              tension: 0.3
            },
            {
              label: "Skipped",
              data: list.map(s => s.skipped),
              borderColor: "#7f8c8d",
              backgroundColor: "rgba(127, 140, 141, 0.1)",
              tension: 0.3
            }
          ]
        },
        options: {
          responsive: true,
          plugins: { legend: { position: "top" } },
          scales: { y: { beginAtZero: true, ticks: { precision:0 } } }
        }
      });
    }
    

    /* ========= Sidebar Actions ========= */
    darkModeBtn.onclick = () => {
      document.body.classList.toggle("dark");
    };

    exportJsonBtn.onclick = () => {
      if (!currentProfile || !sessions[currentProfile]) return alert("Select a profile first");
      const payload = {
        schema: "study-tracker.v1",
        profile: currentProfile,
        sessions: sessions[currentProfile] || []
      };
      const blob = new Blob([JSON.stringify(payload, null, 2)], { type: "application/json" });
      const url = URL.createObjectURL(blob);
      const a = document.createElement("a");
      a.href = url;
      a.download = `${currentProfile}_backup.json`;
      a.click();
      URL.revokeObjectURL(url);
    };

    importJsonBtn.onclick = () => importJsonInput.click();
    
    importJsonInput.onchange = e => {
      const file = e.target.files[0];
      if (!file) return;
      if (!db) return alert("Database not connected");
      
      const reader = new FileReader();
      reader.onload = async () => {
        try {
          const data = JSON.parse(reader.result);
          if (!currentProfile) return alert("Select a profile first");
          const imported = Array.isArray(data) ? data : (data.sessions || []);
          
          const batch = db.batch();
          imported.forEach(session => {
            // Remove 'id' field as Firestore will generate a new one
            delete session.id;
            session.profileName = currentProfile; // ensure it's linked
            const newDocRef = db.collection("sessions").doc();
            batch.set(newDocRef, session);
          });
          await batch.commit();
          
          alert(`Imported ${imported.length} sessions into "${currentProfile}".`);
          importJsonInput.value = "";
        } catch (err) {
          console.error("Error importing data:", err);
          alert("Invalid JSON file or an error occurred during import.");
        }
      };
      reader.readAsText(file);
    };

    exportPdfBtn.onclick = () => {
      if (!currentProfile || !sessions[currentProfile]) return alert("Select a profile first");
      const list = sessions[currentProfile] || [];
      const { jsPDF } = window.jspdf;
      const doc = new jsPDF({ unit: "pt", format: "a4" });

      let y = 40;
      doc.setFontSize(16);
      doc.text(`Study Report ‚Äî ${currentProfile}`, 40, y);
      y += 16;

      // totals
      let totalQs = 0, totalDur = 0;
      let sumC=0,sumW=0,sumS=0;
      list.forEach(s=>{
        const t = s.correct + s.wrong + s.skipped;
        totalQs += t;
        totalDur += (s.durationMs||0);
        sumC += s.correct; sumW += s.wrong; sumS += s.skipped;
      });
      y += 10;
      doc.setFontSize(11);
      doc.text(`Sessions: ${list.length}`, 40, y); y += 14;
      doc.text(`Total Questions: ${totalQs}`, 40, y); y += 14;
      doc.text(`Avg Duration: ${list.length ? formatTime(Math.round(totalDur/list.length)) : "00:00:00"}`, 40, y); y += 20;
      doc.text(`Overall: Correct ${sumC} (${percent(sumC,totalQs)}) | Wrong ${sumW} (${percent(sumW,totalQs)}) | skipped ${sumS} (${percent(sumS,totalQs)})`, 40, y);
      y += 24;

      // sessions
      doc.setFontSize(12);
      list.forEach((s, i) => {
        const t = s.correct + s.wrong + s.skipped;
        const line1 = `${i+1}. ${s.name}`;
        const line2 = `${new Date(s.start).toLocaleString()} ‚Ä¢ Duration ${formatTime(s.durationMs)} ‚Ä¢ Qs ${t}`;
        const line3 = `Correct ${s.correct} (${percent(s.correct,t)}) | Wrong ${s.wrong} (${percent(s.wrong,t)}) | skipped ${s.skipped} (${percent(s.skipped,t)})`;

        if (y > 760) { doc.addPage(); y = 40; }
        doc.text(line1, 40, y); y += 14;
        doc.setFontSize(11);
        doc.text(line2, 40, y); y += 14;
        doc.text(line3, 40, y); y += 18;
        doc.setFontSize(12);
      });

      doc.save(`${currentProfile}_report.pdf`);
    };

    showStatsBtn.onclick = () => {
      const willShow = statsPanel.classList.contains("hidden");
      if (willShow) renderStatsPanel();
      statsPanel.classList.toggle("hidden");
    };

    showGraphsBtn.onclick = () => {
      if (!currentProfile) return alert("Select a profile first");
      renderGraphs();
      graphModal.style.display = "block";
      graphModal.setAttribute("aria-hidden", "false");
    };

    closeGraphModal.onclick = () => {
      graphModal.style.display = "none";
      graphModal.setAttribute("aria-hidden", "true");
    };

    window.addEventListener("click", (e) => {
      if (e.target === graphModal) {
        graphModal.style.display = "none";
        graphModal.setAttribute("aria-hidden", "true");
      }
    });

    /* ========= Startup ========= */
    function boot() {
      console.log("Starting application...");
      
      // Wait for scripts to load completely
      if (typeof firebase === 'undefined') {
        console.log("Waiting for Firebase SDK to load...");
        setTimeout(() => {
          if (typeof firebase === 'undefined') {
            console.error("Firebase SDK failed to load after timeout");
            connectionStatus.textContent = "SDK Failed";
            connectionStatus.className = "status-indicator status-error";
            alert("Firebase SDK failed to load. Please check your internet connection and refresh the page.");
            return;
          }
          initializeFirebase();
        }, 2000);
        return;
      }
      
      // Initialize Firebase
      initializeFirebase();
      
      // Set initial UI state
      setStudyControlsEnabled(false);
    }

    // Start the app when DOM and all scripts are ready
    window.addEventListener('load', () => {
      console.log("Window loaded, starting boot sequence...");
      boot();
    });
  </script>
</body>
</html>
